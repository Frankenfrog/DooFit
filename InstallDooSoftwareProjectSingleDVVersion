#!/bin/bash
uuid=`uuidgen -r`

module=$1
dv_version=$2
base_dir=$3
expected_args=3
# set number of CPUs (not used currently)
num_cpu=$((`cat /proc/cpuinfo | grep processor | wc -l` / 2))
#CMAKE=/usr/local/bin/cmake

if [ $# -ne $expected_args ]
then
  echo "Usage: `basename $0` Module DaVinciVersion BaseDir"
  exit 2
fi

shift
shift
shift

echo "Installing $module for DaVinci $dv_version from $base_dir"

ver_main=$(echo $dv_version|cut -c2-3)
ver_sub=$(echo $(echo $dv_version|cut -d"r" -f2)|cut -d"p" -f1)
# the following if cases are really ugly and make something hardcoded which we probably would like to have not hardcoded but due to the change from
# SetupProject to lb-run and additionally the change from gcc48 to gcc49 in lhcb I don't see a better solution right now
if [[ $dv_version == "v36r3p1" ]]; then
  source /lhcbsoft/LHCbSoftwareSetup.sh x86_64-slc6-gcc49-opt > /dev/null 2>&1
  source SetupProject.sh DaVinci $dv_version > /dev/null 2>&1
elif [[ $ver_main < 36 || ($ver_main == 36 && $ver_sub<4) ]]; then
  source /lhcbsoft/LHCbSoftwareSetup.sh x86_64-slc6-gcc48-opt > /dev/null 2>&1
  source SetupProject.sh DaVinci $dv_version > /dev/null 2>&1
else
  source /lhcbsoft/LHCbSoftwareSetup.sh x86_64-slc6-gcc49-opt > /dev/null 2>&1
  IFS=$'\n'
  for i in $(lb-run DaVinci/$dv_version); do if [[ $i != *"BASH_FUNC_"* ]] && [[ $i != *"}" ]] && [[ $i != *"LC_CTYPE"* ]]; then export $i; fi; done
fi
source /doosoft/bin/LoadDooSoftware --ignore-local


mkdir /tmp/$uuid
cd /tmp/$uuid
echo "Starting build"
echo

#cmake -DCMAKE_INSTALL_PREFIX=$DOOSOFTROOT/$module/ROOT_v$ROOTVERS $base_dir && make VERBOSE="" -j $num_cpu
$CMAKE_EXECUTABLE -DCMAKE_INSTALL_PREFIX=$DOOSOFTROOT/$module/ROOT_v$ROOTVERS $base_dir -DCMAKE_BUILD_TYPE=Release && make VERBOSE=""
rc=$?
if [[ $rc != 0 ]] ; then
  make VERBOSE=""
  echo
  echo
  echo
  echo
  echo "ERROR: Could not complete build for DaVinci $dv_version"
  echo
  echo
  echo
  echo
  rm -rf /tmp/$uuid
  exit 1
fi
echo
echo "Deleting old version and installing new."
echo
rm -rf $DOOSOFTROOT/$module/ROOT_v$ROOTVERS
mkdir -p $DOOSOFTROOT/$module/ROOT_v$ROOTVERS/lib
make install
cd /
rm -rf /tmp/$uuid

echo
echo "Build successful for DaVinci $dv_version"
echo
